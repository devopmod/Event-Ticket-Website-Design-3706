<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug Seat Status</title>
</head>
<body>
  <h1>–û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å seat status</h1>
  <button id="runTest">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
  <div id="results" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; min-height: 200px;"></div>

  <script type="module">
    // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º fetch –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
    (function() {
      const originalFetch = window.fetch;
      window.fetch = function(...args) {
        const [url, options] = args;
        
        // –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –º–µ—Å—Ç–∞
        if (url.includes('event_seats_fanaticka_7a3x9d') && 
            options?.method === 'PATCH' || 
            options?.method === 'POST') {
          
          console.group('üîç –ü–ï–†–ï–•–í–ê–ß–ï–ù –ó–ê–ü–†–û–° –ö –¢–ê–ë–õ–ò–¶–ï –ú–ï–°–¢');
          console.log('URL:', url);
          console.log('–ú–µ—Ç–æ–¥:', options.method);
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º body
          let body = options.body;
          if (body) {
            const bodyStr = typeof body === 'string' ? body : JSON.stringify(body);
            console.log('Body –¥–æ:', bodyStr);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ "hold" –≤ –∑–∞–ø—Ä–æ—Å–µ
            if (bodyStr.includes('"hold"')) {
              console.error('‚ùå –ù–ê–ô–î–ï–ù–û "hold" –í –ó–ê–ü–†–û–°–ï!');
              console.trace('–°—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤:');
            }
          }
          
          console.groupEnd();
        }
        
        return originalFetch.apply(this, args);
      };
    })();
    
    // –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    
    const SUPABASE_URL = 'https://kakiytbuqfhjafpacyoj.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtha2l5dGJ1cWZoamFmcGFjeW9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NzcyNTYsImV4cCI6MjA2ODQ1MzI1Nn0.dO4ebeEGgDU__RIP-MQZ4Wydiyb02Ij3yivvqu4mIog';
    
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    const resultsDiv = document.getElementById('results');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–≥–∏ –≤ UI
    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.textContent = message;
      div.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
      resultsDiv.appendChild(div);
    }
    
    // –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    async function testSeatStatus() {
      log('–ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç...');
      
      try {
        // –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å
        const testEventId = 'debug-test-123';
        const testSeatId = 'debug-seat-1';
        
        log('1. –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤–æ–µ –º–µ—Å—Ç–æ...');
        const { error: insertError } = await supabase
          .from('event_seats_fanaticka_7a3x9d')
          .upsert([{
            event_id: testEventId,
            seat_id: testSeatId,
            status: 'free',
            section: 'DEBUG',
            row: 1
          }]);
        
        if (insertError) {
          log(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${insertError.message}`, 'error');
        } else {
          log('–ú–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ', 'success');
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
        log('2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å...');
        const { data: currentStatus, error: getError } = await supabase
          .from('event_seats_fanaticka_7a3x9d')
          .select('status')
          .eq('event_id', testEventId)
          .eq('seat_id', testSeatId)
          .single();
        
        if (getError) {
          log(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è: ${getError.message}`, 'error');
        } else {
          log(`–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: ${currentStatus.status}`, 'success');
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ "held"
        log('3. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "held"...');
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ "held"...');
        
        const { data: updateData, error: updateError } = await supabase
          .from('event_seats_fanaticka_7a3x9d')
          .update({ status: 'held' })
          .eq('event_id', testEventId)
          .eq('seat_id', testSeatId)
          .select();
        
        if (updateError) {
          log(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ${updateError.message}`, 'error');
        } else {
          log(`–û–±–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ: ${JSON.stringify(updateData)}`, 'success');
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
        log('4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å...');
        const { data: finalStatus, error: finalError } = await supabase
          .from('event_seats_fanaticka_7a3x9d')
          .select('status')
          .eq('event_id', testEventId)
          .eq('seat_id', testSeatId)
          .single();
        
        if (finalError) {
          log(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞: ${finalError.message}`, 'error');
        } else {
          log(`–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å: ${finalStatus.status}`, 'success');
          
          if (finalStatus.status === 'hold') {
            log('‚ùå –ü–†–û–ë–õ–ï–ú–ê –ù–ê–ô–î–ï–ù–ê! –°—Ç–∞—Ç—É—Å —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è –∫–∞–∫ "hold" –≤–º–µ—Å—Ç–æ "held"', 'error');
          } else if (finalStatus.status === 'held') {
            log('‚úÖ –°–¢–ê–¢–£–° –ö–û–†–†–ï–ö–¢–ï–ù! –°–æ—Ö—Ä–∞–Ω–∏–ª—Å—è –∫–∞–∫ "held"', 'success');
          }
        }
        
      } catch (e) {
        log(`–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: ${e.message}`, 'error');
        console.error(e);
      }
    }
    
    // –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –ø–æ –∫–Ω–æ–ø–∫–µ
    document.getElementById('runTest').addEventListener('click', testSeatStatus);
  </script>
</body>
</html>