<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    button {
      background-color: #3B82F6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-bottom: 20px;
    }
    button:hover {
      background-color: #2563EB;
    }
    .log {
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 10px;
      height: 400px;
      overflow-y: auto;
      font-family: monospace;
      white-space: pre-wrap;
      margin-bottom: 20px;
    }
    .success {
      color: #10B981;
      font-weight: bold;
    }
    .error {
      color: #EF4444;
      font-weight: bold;
    }
    .warning {
      color: #F59E0B;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å seat status</h1>
    <button id="runTest">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
    <div id="log" class="log"></div>
    <div id="result"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    const logElement = document.getElementById('log');
    const resultElement = document.getElementById('result');
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const line = document.createElement('div');
      line.textContent = `[${timestamp}] ${message}`;
      if (type === 'error') line.classList.add('error');
      if (type === 'success') line.classList.add('success');
      if (type === 'warning') line.classList.add('warning');
      logElement.appendChild(line);
      logElement.scrollTop = logElement.scrollHeight;
    }
    
    function setResult(success, message) {
      resultElement.innerHTML = `
        <div class="${success ? 'success' : 'error'}">
          <h2>${success ? '‚úÖ –¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω' : '‚ùå –¢–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω'}</h2>
          <p>${message}</p>
        </div>
      `;
    }
    
    // –ü–µ—Ä–µ—Ö–≤–∞—Ç fetch –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    const originalFetch = window.fetch;
    window.fetch = async function(...args) {
      const [url, options = {}] = args;
      
      if (url.includes('event_seats_fanaticka_7a3x9d') && options?.method) {
        log(`üîç –ü–µ—Ä–µ—Ö–≤–∞—á–µ–Ω ${options.method} –∑–∞–ø—Ä–æ—Å –∫ —Ç–∞–±–ª–∏—Ü–µ –º–µ—Å—Ç`);
        
        if (options.body) {
          const bodyText = typeof options.body === 'string' ? options.body : JSON.stringify(options.body);
          log(`üì¶ Body: ${bodyText}`);
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ 'hold'
          if (bodyText.includes('"hold"')) {
            log(`‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ "hold" –≤ –∑–∞–ø—Ä–æ—Å–µ!`, 'warning');
            
            // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º—É
            if (typeof options.body === 'string') {
              options.body = options.body.replace('"hold"', '"held"');
              log(`‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞: ${options.body}`, 'success');
            }
          }
        }
      }
      
      // –í—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π fetch
      const response = await originalFetch.apply(this, args);
      
      // –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —Ç–∞–±–ª–∏—Ü–µ –º–µ—Å—Ç
      if (url.includes('event_seats_fanaticka_7a3x9d') && options?.method) {
        const clone = response.clone();
        try {
          const data = await clone.json();
          log(`üì• –û—Ç–≤–µ—Ç: ${JSON.stringify(data)}`);
        } catch (e) {
          log(`üì• –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç: ${e.message}`, 'error');
        }
      }
      
      return response;
    };
    
    // –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç Supabase
    const SUPABASE_URL = 'https://kakiytbuqfhjafpacyoj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtha2l5dGJ1cWZoamFmcGFjeW9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NzcyNTYsImV4cCI6MjA2ODQ1MzI1Nn0.dO4ebeEGgDU__RIP-MQZ4Wydiyb02Ij3yivvqu4mIog';
    
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    async function testFix() {
      log('üß™ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è...');
      
      try {
        // 1. –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –º–µ—Å—Ç–æ
        const testEventId = 'test-fix-' + Date.now();
        const testSeatId = 'seat-' + Date.now();
        
        log('1Ô∏è‚É£ –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –º–µ—Å—Ç–æ...');
        const { error: insertError } = await supabase
          .from('event_seats_fanaticka_7a3x9d')
          .upsert([{
            event_id: testEventId,
            seat_id: testSeatId,
            status: 'free',
            section: 'TEST',
            row: 1
          }]);
        
        if (insertError) {
          log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–µ—Å—Ç–∞: ${insertError.message}`, 'error');
          setResult(false, '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –º–µ—Å—Ç–æ');
          return;
        }
        
        log('‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ –º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ', 'success');
        
        // 2. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "held"
        log('2Ô∏è‚É£ –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "held"...');
        const { data: updateData, error: updateError } = await supabase
          .from('event_seats_fanaticka_7a3x9d')
          .update({ status: 'held' })
          .eq('event_id', testEventId)
          .eq('seat_id', testSeatId)
          .select();
        
        if (updateError) {
          log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: ${updateError.message}`, 'error');
          setResult(false, '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–µ—Å—Ç–∞');
          return;
        }
        
        log(`‚úÖ –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω: ${JSON.stringify(updateData)}`, 'success');
        
        // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
        log('3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –≤ –±–∞–∑–µ...');
        const { data: checkData, error: checkError } = await supabase
          .from('event_seats_fanaticka_7a3x9d')
          .select('status')
          .eq('event_id', testEventId)
          .eq('seat_id', testSeatId)
          .single();
        
        if (checkError) {
          log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞: ${checkError.message}`, 'error');
          setResult(false, '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å');
          return;
        }
        
        log(`üìä –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –≤ –±–∞–∑–µ: "${checkData.status}"`);
        
        if (checkData.status === 'held') {
          log('‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –†–ê–ë–û–¢–ê–ï–¢! –°—Ç–∞—Ç—É—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫ "held"', 'success');
          setResult(true, '–°—Ç–∞—Ç—É—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫ "held"');
        } else if (checkData.status === 'hold') {
          log('‚ùå –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ù–ï –†–ê–ë–û–¢–ê–ï–¢! –°—Ç–∞—Ç—É—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫ "hold"', 'error');
          setResult(false, '–°—Ç–∞—Ç—É—Å –≤—Å–µ –µ—â–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ "hold"');
        } else {
          log(`‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å: "${checkData.status}"`, 'warning');
          setResult(false, `–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å: "${checkData.status}"`);
        }
        
        // 4. –û—á–∏—Å—Ç–∫–∞ - —É–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –º–µ—Å—Ç–æ
        log('4Ô∏è‚É£ –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –º–µ—Å—Ç–æ...');
        await supabase
          .from('event_seats_fanaticka_7a3x9d')
          .delete()
          .eq('event_id', testEventId)
          .eq('seat_id', testSeatId);
        
        log('‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ –º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
        
      } catch (e) {
        log(`üí• –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: ${e.message}`, 'error');
        console.error(e);
        setResult(false, `–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: ${e.message}`);
      }
    }
    
    // –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –ø–æ –∫–Ω–æ–ø–∫–µ
    document.getElementById('runTest').addEventListener('click', testFix);
  </script>
</body>
</html>